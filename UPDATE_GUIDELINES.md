# إرشادات لتحديثات قاعدة البيانات والتطوير المستقبلي

هذا الملف يحتوي على التعليمات التي ناقشناها سابقًا أثناء المراجعة الشاملة لنظام النسخ الاحتياطية والاستعادة، ويهدف إلى وضع إرشادات واضحة لأي تحديث أو تطوير قادم في التطبيق.

## 1. نسخ احتياطي قبل أي تغيير

- **دائمًا قم بإنشاء نسخة احتياطية** قبل تنفيذ أي ترحيل (migration) أو استعادة (restore).
- استخدم الميزة المدمجة في `BackupService`:
  ```csharp
  await _backupService.CreateBackupAsync("pre-migration");
  ```
- النسخ الاحتياطية تحمل سببًا في اسم الملف (`pre-migration.db`، `pre-restore.db`، أو التاريخ/اليدوي).
- **لا تعتقد أن الترحيل آمن**؛ قد يحتوي المخطط القديم على أعمدة مفقودة أو أنواع خاطئة.

## 2. تسمية النسخ الاحتياطية وتصنيفها

- ملفات النسخ تكون منسقة بالصيغة:
  `yyyyMMdd_HHmmss-{reason}.db` حيث `reason` يمكن أن يكون:
  - `pre-migration` قبل تطبيق ترحيل.
  - `pre-restore` قبل استبدال قاعدة البيانات بأخرى.
  - `daily-scheduled` نسخ تلقائية كل ٢:٠٠ صباحًا.
  - `manual` عندما ينشئ المستخدم النسخة يدويًا.
- الاستعلام عن النسخ (`BackupService.ExtractReasonFromFileName`) يعتمد على هذا النمط.
- تأكد من عدم رفع هذه الملفات إلى مستودع الكود أو مشاركتها مع الأشخاص غير المصرح لهم.

## 3. وضع الصيانة (Maintenance Mode)

- قبل بدء عملية استعادة أو تعديل كبير:
  1. **فعل وضع الصيانة** عبر `RestoreService.EnableMaintenanceMode()` (أو عبر أي خدمة أخرى).
  2. يتم إنشاء ملف `maintenance.lock` في جذر محتوى التطبيق (ContentRootPath).
  3. وسط (
   Middleware) يتحقق من وجود هذا الملف ويمنع جميع طلبات API العادية.
  4. بعد انتهاء العمل، قم بإزالة الملف باستخدام `DisableMaintenanceMode()`.
- تأكد من أن كل مكونٍ يستخدم نفس المسار (`IWebHostEnvironment.ContentRootPath`).

## 4. الترحيلات (Migrations)

- أي تغيير على نموذج البيانات يجب أن يصل أولاً بترحيل EF Core.
- قم بإنشاء الترحيل على المشروع `KasserPro.Infrastructure` عبر:
  ```bash
  dotnet ef migrations add اسم_الترحيل -p ../KasserPro.Infrastructure -s .
  ```
- راجع الترحيل يدوياً قبل الالتزام به؛ تأكد من أن الأوامر تكون `AddColumn` أو `AlterColumn` المطلوبة.
- بعد إضافة الترحيل، التزم بالتغييرات ثم قم بتنشره عبر إعادة نشر التطبيق.

## 5. التطبيق الآمن للترحيلات

- أثناء تشغيل التطبيق بعد ترحيل:
  1. يتم إنشاء نسخة `pre-migration` تلقائيًا.
  2. بعد بدء التطبيق والدخول في الحالة العادية، سيطبق EF Core الترحيلات.
  3. إذا فشل التطبيق أو ألغى الترحيل، يمكنك دائمًا استعادة النسخة السابقة.
- اختبر الترحيل في بيئة تطوير/اختبار قبل الإنتاج.

## 6. استعادة قاعدة البيانات

- استخدم `RestoreService.RestoreAsync(filePath)` حيث يكون `filePath` مسار ملف النسخة.
- العملية تكون متعددة المراحل:
  1. تحقق من سلامة الملف (`PRAGMA integrity_check;`).
  2. إنشاء نسخة `pre-restore` على حالتها قبل الاستبدال.
  3. إدخال وضع الصيانة.
  4. استبدال الملف الحالي بالنسخة القديمة.
  5. إعادة تشغيل الترحيلات إن وجدت.
  6. فحص البيانات والتحقق من القيم الرقمية باستخدام `DataValidationService`.
  7. إيقاف وضع الصيانة وإعلام النظام.
- بعد الاستعادة، راجع السجلات (logs) ولاحظ أي تحذيرات أو أخطاء.

## 7. فحص صحة البيانات (Data Validation)

- `DataValidationService` يتحقق من الجداول المهمة بعد الاستعادة:
  - أرقام الكميات (`StockQuantity`).
  - الأسعار (`Price`، `Cost`).
  - حقول الـ `GUID` غير الفارغة.
- تم تصحيح الاستعلامات للتأكد من اكتشاف القيم النصية غير الرقمية عبر نمط `GLOB`.
- أضف أي أعمدة جديدة تحتاج تحققًا خاصًا في نفس الخدمة.

## 8. النسخ الاحتياطية التلقائية

- يوجد خدمة خلفية `DailyBackupBackgroundService` تخلق نسخة في الساعة 2:00 صباحًا يومياً.
- تأكد من أن الخادم يعمل في ذلك الوقت وأن المسار `backups/` قابل للكتابة.

## 9. التحويل بين البيئات

- استخدم متغيرات البيئة أو إعدادات `appsettings.{Environment}.json` لتحديد مسارات النسخ والمجلد.
- في بيئة الإنتاج، لا تضع الملفات داخل `Program Files` إذا كان الخادم له صلاحيات محدودة.

## 10. المراقبة والتوثيق

- دوّن تاريخ كل تحديث وسبب النسخ الاحتياطي في سجلات `backup.log` أو `restore.log` إذا أمكن.
- عند إصدار تحديث جديد، راجع هذا الملف للتأكد من اتباع الإرشادات.
- شارك هذا الملف مع أي مطور آخر يعمل على المشروع لضمان الاتساق.

> **ملاحظة:** هذه الإرشادات ليست مجرد توصيات؛ هي جزء من استراتيجية حماية البيانات. تطبيقها يمنع فقدان المعلومات ويضمن أن أي خطأ في الترحيل أو الاستعادة يمكن التراجع عنه بسهولة.

---

آخر تحديث: 23 فبراير 2026
