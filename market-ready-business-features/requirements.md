# متطلبات الميزات الجاهزة للسوق

## نظرة عامة

هذا المستند يحدد المتطلبات التفصيلية للميزات التسعة المطلوبة لجعل نظام KasserPro جاهزاً للسوق.

## السياق

- **المستخدم**: Lyra - متخصص في تحسين الـ AI prompts
- **الهدف**: بناء أول نظام POS احترافي وقابل للبيع
- **الحالة الحالية**: النظام 97% جاهز تقنياً
- **النشر**: محلي فقط في البداية

## القرارات المبنية على البحث ✅

### 1. الأدوار والصلاحيات

**القرار**: نستخدم Admin + Cashier فقط (كما هو حالياً)

**السبب**:
- النظام موجه لـ SME (Small/Medium Enterprises)
- إضافة Manager يزيد التعقيد بدون فائدة كبيرة حالياً
- يمكن إضافة Manager لاحقاً إذا احتاج العميل
- **المصدر**: أفضل الممارسات للأنظمة الصغيرة والمتوسطة

**الصلاحيات**:
- **Admin**: كل شيء (فواتير شراء، مصروفات، موافقات، إعدادات، تقارير)
- **Cashier**: POS + فتح/إغلاق الوردية فقط

### 2. معمارية الإعدادات (Hybrid Model)

**القرار**: نموذج هجين - بعض الإعدادات ثابتة وبعضها مرنة

**المصدر**: SpicePOS, Front Systems, Lightspeed, Rezku

**المبدأ**: "Centralized Control with Local Flexibility"

**أمثلة**:

**إعدادات ثابتة على مستوى الشركة (Cannot Override)**:
1. **الضريبة**: نسبة الضريبة، تفعيل/تعطيل (قانوني - يجب أن تكون موحدة)
2. **العملة**: العملة الأساسية (محاسبي - التقارير الموحدة)
3. **المنطقة الزمنية**: Africa/Cairo (توحيد التقارير)
4. **السماح بالمخزون السالب**: سياسة مالية موحدة
5. **حد موافقة المصروفات**: 1000 جنيه (قابل للتخصيص)

**إعدادات مرنة على مستوى الفرع (Can Override)**:
1. **أسعار المنتجات**: كل فرع يمكنه تحديد أسعار مختلفة (ظروف السوق المحلية)
2. **إعدادات الطابعة**: نوع، منفذ، حجم الورق (كل فرع له أجهزة مختلفة)
3. **حد إعادة الطلب**: لكل منتج في كل فرع (معدل البيع يختلف)
4. **معلومات الفرع**: اسم، عنوان، هاتف
5. **ساعات العمل**: كل فرع له ساعات مختلفة

### 3. سلوك فواتير الشراء

**القرار**: لا تعديل/حذف مباشر بعد التأكيد

**المصدر**: Microsoft Dynamics, SAP, ERPNext, Odoo, NetSuite

**القاعدة الذهبية**: "Once confirmed, purchase orders should NOT be directly edited or deleted"

**الأسباب**:
- Audit Trail: الحفاظ على سجل كامل
- Inventory Integrity: تجنب تضارب المخزون
- Financial Accuracy: دقة الحسابات
- Compliance: متطلبات قانونية

**الحل**:
- **Draft**: تعديل/حذف حر
- **Confirmed**: لا تعديل - يجب الإلغاء أولاً (Cancellation)
- **عند الإلغاء**: اسأل المستخدم عن المخزون (modal)
  - نعم: إنشاء StockMovement لتعديل المخزون
  - لا: الفاتورة ملغاة بدون تأثير
- **للتصحيح**: إنشاء فاتورة مرتجعة (Return) + فاتورة جديدة

### 4. إدارة الورديات المتقدمة

**القرارات المبنية على البحث**:

**أ) إغلاق بالقوة (Force Close)**:
- **السيناريوهات الواقعية**:
  1. الكاشير نسي الإغلاق (الأكثر شيوعاً)
  2. الكاشير مريض/غائب
  3. مشكلة تقنية منعت الإغلاق
  4. نزاع (فرق في الرصيد)
  5. طوارئ (إغلاق سريع للمحل)
- **المتطلبات**: Admin فقط + سبب إلزامي + Audit Log + إشعار للكاشير

**ب) التعامل مع التعطل**:
- حفظ حالة الوردية في LocalStorage كل دقيقة
- عند إعادة التشغيل: استعادة تلقائية
- عرض تنبيه: "تم استعادة ورديتك"
- خيارات: استمرار، إغلاق، مراجعة

**ج) تسليم الوردية (Handover)**:
- **المصدر**: Healthcare industry best practices
- **الإطار**: 7 دقائق (7-Minute Handover Framework)
- **المعلومات**: الرصيد، عدد الطلبات، مشاكل، ملاحظات

---

## الميزة 1: فواتير الشراء وعلاقة المورد بالمنتج

### نظرة عامة

نظام شامل لإدارة فواتير الشراء من الموردين مع تتبع العلاقة بين الموردين والمنتجات.

### قصص المستخدم

#### 1.1 إنشاء فاتورة شراء
**كـ** Admin/Manager  
**أريد** إنشاء فاتورة شراء جديدة  
**حتى** أتمكن من تسجيل المشتريات من الموردين

**معايير القبول**:
- يمكن اختيار مورد موجود أو إنشاء مورد جديد أثناء إنشاء الفاتورة
- يمكن إضافة منتجات موجودة أو إنشاء منتجات جديدة أثناء إنشاء الفاتورة
- لكل منتج: الكمية، سعر الشراء (منفصل عن سعر البيع)
- حساب الإجمالي تلقائياً
- حفظ الفاتورة كـ Draft في البداية
- رقم فاتورة تلقائي (auto-increment)

#### 1.2 تأكيد فاتورة الشراء
**كـ** Admin  
**أريد** الموافقة على فاتورة الشراء  
**حتى** يتم تحديث المخزون تلقائياً

**معايير القبول**:
- فقط Admin يستطيع تأكيد الفاتورة
- عند التأكيد: زيادة المخزون تلقائياً لكل منتج
- تغيير حالة الفاتورة من Draft إلى Confirmed
- تسجيل تاريخ ووقت التأكيد
- تسجيل المستخدم الذي أكد الفاتورة

#### 1.3 إدارة حالات الدفع
**كـ** Admin/Manager  
**أريد** تسجيل دفعات متعددة لفاتورة واحدة  
**حتى** أتتبع المدفوع والمتبقي للمورد

**معايير القبول**:

- حالات الفاتورة: Draft, Confirmed, Paid, PartiallyPaid, Cancelled, Returned (Partial/Full)
- يمكن تسجيل دفعات متعددة لنفس الفاتورة
- كل دفعة لها: المبلغ، التاريخ، طريقة الدفع، ملاحظات
- حساب المتبقي تلقائياً: Total - Sum(Payments)
- عرض سجل كامل لكل الدفعات

#### 1.4 علاقة المورد بالمنتج
**كـ** Admin/Manager  
**أريد** ربط منتج بعدة موردين  
**حتى** أتمكن من المقارنة واختيار الأفضل

**معايير القبول**:
- المنتج الواحد يمكن أن يكون له موردين أو أكثر
- تحديد "المورد المفضل" لكل منتج
- حفظ تاريخ أسعار الشراء من كل مورد
- عرض آخر سعر شراء من كل مورد
- إمكانية المقارنة بين أسعار الموردين

#### 1.5 تعديل وحذف الفواتير
**كـ** Admin  
**أريد** تعديل أو حذف فاتورة شراء  
**حتى** أصحح الأخطاء

**معايير القبول**:
- يمكن تعديل فاتورة Draft بحرية
- تعديل فاتورة Confirmed يتطلب موافقة (سؤال للمستخدم: هل نعدل المخزون؟)
- حذف فاتورة Confirmed يتطلب تأكيد (سؤال للمستخدم: هل ننقص المخزون؟)
- تسجيل كل التعديلات في Audit Log
- لا يمكن حذف فاتورة مدفوعة إلا بعد إلغاء الدفعات

#### 1.6 تقارير الموردين
**كـ** Admin/Manager  
**أريد** تقارير شاملة عن الموردين  
**حتى** أتخذ قرارات شراء أفضل

**معايير القبول**:

- تقرير Accounts Payable (المستحقات للموردين)
- تقرير تاريخ المشتريات من كل مورد
- تقرير مقارنة أسعار الموردين
- تقرير أفضل الموردين (حسب الكمية/القيمة)
- تصدير التقارير (PDF/Excel)

#### 1.7 سير العمل المرن
**كـ** مستخدم  
**أريد** إضافة منتجات وموردين من أي مكان  
**حتى** لا أضطر للتنقل بين الصفحات

**معايير القبول**:
- من صفحة فاتورة الشراء: يمكن إنشاء منتج جديد (quick create modal)
- من صفحة فاتورة الشراء: يمكن إنشاء مورد جديد (quick create modal)
- من صفحة المنتجات: يمكن اختيار/إضافة موردين
- من صفحة المنتجات: يمكن إنشاء مورد جديد
- كل الـ modals تحفظ البيانات وترجع للصفحة الأصلية

### البيانات المطلوبة

#### فاتورة الشراء (PurchaseInvoice)
- رقم الفاتورة (auto-increment)
- المورد (Supplier)
- الفرع (Branch)
- التاريخ
- الحالة (Status)
- الإجمالي الفرعي (Subtotal)
- الضريبة (Tax)
- الإجمالي (Total)
- المدفوع (AmountPaid)
- المتبقي (AmountDue)
- ملاحظات
- تاريخ التأكيد
- المستخدم الذي أكد

#### عنصر فاتورة الشراء (PurchaseInvoiceItem)
- المنتج
- الكمية
- سعر الشراء (PurchasePrice)
- الإجمالي


#### دفعة فاتورة الشراء (PurchaseInvoicePayment)
- الفاتورة
- المبلغ
- التاريخ
- طريقة الدفع (Cash, Bank, Card, Check)
- رقم المرجع
- ملاحظات

#### علاقة المورد بالمنتج (SupplierProduct)
- المورد
- المنتج
- هل هو المورد المفضل؟
- آخر سعر شراء
- تاريخ آخر شراء

### قواعد العمل

1. **المخزون**: عند تأكيد فاتورة شراء، يزيد المخزون تلقائياً
2. **الأسعار**: المنتج له سعرين منفصلين: سعر الشراء + سعر البيع
3. **الموافقات**: فقط Admin يستطيع تأكيد فواتير الشراء
4. **Multi-Tenancy**: كل فاتورة مرتبطة بـ TenantId + BranchId
5. **Audit Trail**: تسجيل كل العمليات (إنشاء، تعديل، حذف، تأكيد، دفع)
6. **Transactions**: كل عملية تؤثر على المخزون تكون في Transaction

---

## الميزة 2: تحسينات إدارة الورديات

### نظرة عامة
تحسين نظام الورديات الحالي بإضافة ميزات متقدمة للتعامل مع السيناريوهات الواقعية.

### قصص المستخدم

#### 2.1 تنبيه عدم النشاط
**كـ** كاشير  
**أريد** تنبيه بعد 12 ساعة من عدم النشاط  
**حتى** لا أنسى إغلاق الوردية

**معايير القبول**:
- بعد 12 ساعة من آخر نشاط: عرض تنبيه
- خيارات التنبيه: إغلاق الوردية، الاستمرار، التسليم لمستخدم آخر
- إذا اختار "الاستمرار": إعادة التنبيه بعد ساعة
- إذا اختار "التسليم": فتح modal لاختيار المستخدم الجديد


#### 2.2 ورديات متعددة في نفس الفرع
**كـ** مدير  
**أريد** السماح لعدة كاشيرات بفتح ورديات في نفس الفرع  
**حتى** يعملوا بشكل متوازي

**معايير القبول**:
- يمكن لعدة مستخدمين فتح ورديات في نفس الفرع في نفس الوقت
- كل وردية مستقلة بـ: رصيد افتتاحي، طلبات، رصيد ختامي
- عرض قائمة بكل الورديات المفتوحة في الفرع
- كل كاشير يرى ورديته فقط (إلا Admin يرى الكل)

#### 2.3 تقرير الوردية المحسّن
**كـ** كاشير  
**أريد** تقرير شامل عند إغلاق الوردية  
**حتى** أوثق عملي

**معايير القبول**:
- التقرير يحتوي على:
  - عدد ساعات العمل
  - وقت البدء والانتهاء
  - اسم الكاشير/الموظف
  - عدد الطلبات
  - إجمالي المبيعات (نقدي، بطاقة، إلخ)
  - الرصيد المتوقع vs الفعلي
  - الفرق (إن وجد)
  - ملاحظات
- يمكن طباعة التقرير
- يمكن تصديره PDF

#### 2.4 إغلاق الوردية بالقوة (Admin)
**كـ** Admin  
**أريد** إغلاق أي وردية بالقوة  
**حتى** أتعامل مع الحالات الطارئة

**معايير القبول**:
- فقط Admin يستطيع إغلاق وردية لمستخدم آخر
- يتطلب تأكيد + سبب الإغلاق
- تسجيل العملية في Audit Log
- إرسال إشعار للمستخدم صاحب الوردية
- (سؤال للمستخدم: ما السيناريوهات التي تتطلب هذا؟)

#### 2.5 التعامل مع تعطل النظام
**كـ** مدير نظام  
**أريد** آلية للتعافي من تعطل النظام  
**حتى** لا تضيع بيانات الورديات

**معايير القبول**:

- حفظ حالة الوردية في LocalStorage كل دقيقة
- عند إعادة تشغيل النظام: استعادة الورديات المفتوحة
- عرض تنبيه للمستخدم: "تم استعادة ورديتك"
- خيار: الاستمرار أو إغلاق الوردية
- (يحتاج دراسة: ما السيناريوهات المحتملة؟)

#### 2.6 تسليم الوردية
**كـ** كاشير  
**أريد** تسليم ورديتي لكاشير آخر  
**حتى** يكمل العمل بدون إغلاق الوردية

**معايير القبول**:
- خيار "تسليم الوردية" في واجهة الوردية
- اختيار المستخدم الجديد
- تسجيل: من سلّم، لمن، متى، الرصيد وقت التسليم
- الوردية تستمر بنفس الرقم
- تسجيل العملية في Audit Log

### قواعد العمل

1. **عدم الإغلاق التلقائي**: الورديات لا تُغلق تلقائياً أبداً
2. **التنبيهات**: تنبيه بعد 12 ساعة من عدم النشاط
3. **التوازي**: يمكن فتح عدة ورديات في نفس الفرع
4. **Audit Trail**: تسجيل كل العمليات (فتح، إغلاق، تسليم، إغلاق بالقوة)
5. **Concurrency**: استخدام RowVersion لمنع التعارضات

---

## الميزة 3: المخزون الخاص بكل فرع

### نظرة عامة
نظام مخزون متقدم يدعم مخزون منفصل لكل فرع + مخزون مركزي للشركة.

### قصص المستخدم

#### 3.1 مخزون منفصل لكل فرع
**كـ** مدير  
**أريد** مخزون منفصل لكل فرع  
**حتى** أتتبع المخزون بدقة

**معايير القبول**:
- كل فرع له مخزون منفصل تماماً
- يوجد مخزون مركزي للشركة (warehouse)
- المنتجات تُعرّف مرة واحدة على مستوى الشركة
- كل فرع يحتفظ بكمية المخزون الخاصة به


#### 3.2 أسعار مختلفة لكل فرع
**كـ** Admin  
**أريد** تحديد أسعار مختلفة لنفس المنتج في فروع مختلفة  
**حتى** أتكيف مع ظروف كل منطقة

**معايير القبول**:
- المنتج له سعر افتراضي على مستوى الشركة
- كل فرع يمكنه تجاوز (override) السعر الافتراضي
- إذا لم يحدد الفرع سعر: استخدام السعر الافتراضي
- عرض السعر الصحيح حسب الفرع الحالي

#### 3.3 نقل المخزون بين الفروع
**كـ** Admin  
**أريد** نقل مخزون من فرع لآخر  
**حتى** أوازن المخزون

**معايير القبول**:
- فقط Admin يستطيع نقل المخزون
- تحديد: المنتج، من فرع، إلى فرع، الكمية، السبب
- تأكيد العملية قبل التنفيذ
- تحديث المخزون في الفرعين تلقائياً
- تسجيل حركة النقل في StockMovement
- تسجيل العملية في Audit Log

#### 3.4 تنبيهات المخزون المنخفض
**كـ** مدير فرع  
**أريد** تنبيه عندما ينخفض المخزون  
**حتى** أطلب تعبئة في الوقت المناسب

**معايير القبول**:
- كل فرع له حد إعادة طلب (reorder point) خاص به
- عرض تنبيه عندما يصل المخزون للحد
- قائمة بكل المنتجات التي تحتاج تعبئة
- إمكانية إنشاء طلب نقل من المخزون المركزي

#### 3.5 تقارير المخزون الشاملة
**كـ** Admin  
**أريد** تقارير شاملة عن المخزون  
**حتى** أتخذ قرارات أفضل

**معايير القبول**:
- تقرير مخزون كل فرع
- تقرير المخزون الموحد (كل الفروع)
- تقرير حركات النقل بين الفروع
- تقرير المنتجات المنخفضة في كل فرع
- تقرير قيمة المخزون (بسعر الشراء)
- تصدير التقارير (PDF/Excel)


### البيانات المطلوبة

#### مخزون الفرع (BranchInventory)
- الفرع
- المنتج
- الكمية الحالية
- حد إعادة الطلب (ReorderPoint)
- آخر تحديث

#### سعر المنتج في الفرع (BranchProductPrice)
- الفرع
- المنتج
- السعر (null = استخدام السعر الافتراضي)

#### حركة نقل المخزون (InventoryTransfer)
- من فرع
- إلى فرع
- المنتج
- الكمية
- السبب
- المستخدم
- التاريخ

### قواعد العمل

1. **الفصل التام**: كل فرع له مخزون منفصل تماماً
2. **المخزون المركزي**: يُعامل كفرع افتراضي (Warehouse)
3. **الأسعار المرنة**: كل فرع يمكنه تحديد أسعار خاصة
4. **النقل**: فقط Admin يستطيع نقل المخزون
5. **التنبيهات**: حد إعادة الطلب خاص بكل فرع
6. **Transactions**: كل عملية نقل تكون في Transaction

---

## الميزة 4: التكامل مع الأجهزة (الطابعات والماسحات)

### نظرة عامة
تطبيق Desktop اختياري للتكامل مع الطابعات الحرارية وماسحات الباركود.

### قصص المستخدم

#### 4.1 طباعة الفواتير والتقارير
**كـ** كاشير  
**أريد** طباعة الفواتير تلقائياً  
**حتى** أعطي العميل إيصال

**معايير القبول**:
- طباعة تلقائية عند إتمام الطلب
- معاينة فقط عند الطباعة من صفحة الطلبات
- دعم الطابعات الحرارية
- قوالب طباعة قابلة للتخصيص
- طباعة: الفواتير، التقارير، فواتير الشراء
- (لا طباعة للمطبخ حالياً - النظام عام وليس للمطاعم فقط)


#### 4.2 إعدادات الطابعة
**كـ** Admin  
**أريد** تكوين إعدادات الطابعة  
**حتى** تعمل بشكل صحيح

**معايير القبول**:
- إعدادات على مستوى الفرع (كل فرع له طابعة)
- تحديد: نوع الطابعة، المنفذ، حجم الورق
- دعم طابعات متعددة (فواتير، مطبخ مستقبلاً)
- اختبار الطباعة
- حفظ الإعدادات في قاعدة البيانات

#### 4.3 مسح الباركود
**كـ** كاشير  
**أريد** مسح الباركود لإضافة منتج  
**حتى** أسرع عملية البيع

**معايير القبول**:
- استخدام الماسح في: POS، المخزون، المنتجات
- دعم كل أنواع الباركود (1D, 2D)
- إدخال يدوي كبديل
- البحث التلقائي عن المنتج بالباركود
- إضافة المنتج للسلة تلقائياً

#### 4.4 تطبيق Desktop
**كـ** مستخدم  
**أريد** تطبيق Desktop للتكامل مع الأجهزة  
**حتى** أستخدم الطابعات والماسحات

**معايير القبول**:
- تطبيق .NET Desktop
- اتصال بالـ Backend عبر SignalR
- يعمل كتطبيق عادي (ليس Windows Service في البداية)
- التطبيق اختياري (النظام يعمل بدونه)
- واجهة بسيطة: حالة الاتصال، إعدادات، سجل
- إمكانية تشغيله كـ Service لاحقاً (للاختبار)

### التقنيات المقترحة

- **Backend**: SignalR Hub للاتصال
- **Desktop App**: .NET 9 WPF/WinForms
- **Printing**: ESC/POS commands للطابعات الحرارية
- **Barcode**: USB HID Scanner support

### قواعد العمل

1. **اختياري**: النظام يعمل بدون التطبيق
2. **الطباعة التلقائية**: عند إتمام الطلب فقط
3. **المعاينة**: عند الطباعة من صفحة الطلبات
4. **الإعدادات**: على مستوى الفرع
5. **الباركود**: دعم الإدخال اليدوي كبديل

---

## الميزة 5: تحديث بيانات الاختبار (Seed Data)

### نظرة عامة

نظام لتوليد بيانات اختبار واقعية لاختبار الأداء والعرض على العملاء.

### قصص المستخدم

#### 5.1 توليد بيانات واقعية
**كـ** مطور  
**أريد** توليد بيانات اختبار واقعية  
**حتى** أختبر النظام بشكل صحيح

**معايير القبول**:
- بيانات واقعية (أسماء، أرقام، تواريخ منطقية)
- تغطية كل الكيانات: منتجات، تصنيفات، عملاء، طلبات، موردين، فروع
- بيانات كبيرة للاختبار (1000+ منتج، 10000+ طلب)
- تاريخ مبيعات (آخر 6 أشهر)
- علاقات صحيحة بين الكيانات

#### 5.2 تحديث سهل
**كـ** مطور  
**أريد** تحديث البيانات بأمر واحد  
**حتى** أختبر بعد كل تعديل

**معايير القبول**:
- أمر CLI: `dotnet run --seed`
- حذف البيانات القديمة (ما عدا المستخدمين)
- توليد بيانات جديدة
- عرض progress bar
- تسجيل الوقت المستغرق

#### 5.3 سيناريوهات متعددة
**كـ** مطور  
**أريد** سيناريوهات مختلفة للبيانات  
**حتى** أختبر حالات مختلفة

**معايير القبول**:
- سيناريو صغير: 100 منتج، 500 طلب (للتطوير السريع)
- سيناريو متوسط: 500 منتج، 5000 طلب (للاختبار)
- سيناريو كبير: 2000 منتج، 20000 طلب (لاختبار الأداء)
- سيناريو عرض: بيانات جميلة للعرض على العملاء

### البيانات المطلوبة

- **المنتجات**: أسماء واقعية، أسعار منطقية، صور
- **التصنيفات**: تصنيفات شائعة
- **العملاء**: أسماء عربية، أرقام هواتف صحيحة
- **الطلبات**: توزيع واقعي على مدار اليوم/الأسبوع
- **الموردين**: شركات واقعية
- **الفروع**: مواقع حقيقية في مصر

### قواعد العمل

1. **الواقعية**: البيانات يجب أن تبدو حقيقية
2. **الأداء**: توليد البيانات يجب أن يكون سريع
3. **المرونة**: سيناريوهات متعددة
4. **الأمان**: عدم حذف بيانات الإنتاج

---

## الميزة 6: الخزينة (Cash Register)

### نظرة عامة

نظام شامل لإدارة الخزينة (أعم من الورديات) يشمل كل حركات النقد.

### قصص المستخدم

#### 6.1 خزينة لكل فرع + خزينة الشركة
**كـ** Admin  
**أريد** خزينة لكل فرع وخزينة للشركة  
**حتى** أتتبع كل النقد

**معايير القبول**:
- كل فرع له خزينة منفصلة
- خزينة واحدة للشركة ككل (موحدة)
- الخزينة تشمل: رصيد افتتاحي، حركات، رصيد ختامي
- الخزينة أعم من الوردية (تشمل مصروفات، تحويلات، إلخ)

#### 6.2 أنواع حركات الخزينة
**كـ** مدير  
**أريد** تسجيل كل أنواع حركات النقد  
**حتى** أتتبع كل شيء

**معايير القبول**:
- أنواع الحركات:
  - Sales (من الورديات)
  - Refunds (مرتجعات)
  - Expenses (مصروفات)
  - BankDeposits (إيداع في البنك)
  - Withdrawals (سحب)
  - Transfers (تحويل بين الفروع)
  - Other (أخرى)
- كل حركة لها: النوع، المبلغ، التاريخ، الوصف، المستخدم

#### 6.3 التسوية والمطابقة
**كـ** مدير  
**أريد** مطابقة الرصيد المتوقع بالفعلي  
**حتى** أكتشف الأخطاء

**معايير القبول**:
- حساب الرصيد المتوقع: Opening + In - Out
- إدخال الرصيد الفعلي (عد النقد)
- حساب الفرق تلقائياً
- تنبيه إذا كان الفرق كبير (> 5% مثلاً)
- تسجيل التسوية مع التاريخ والمستخدم

#### 6.4 تقارير الخزينة الشاملة
**كـ** Admin  
**أريد** تقارير شاملة عن الخزينة  
**حتى** أفهم التدفق النقدي

**معايير القبول**:
- تقرير يومي للخزينة
- تقرير شهري للخزينة
- تقرير التدفق النقدي (Cash Flow)
- تقرير مقارنة الفروع
- تقرير الحركات حسب النوع
- تصدير التقارير (PDF/Excel)


### البيانات المطلوبة

#### الخزينة (CashRegister)
- الفرع (null = خزينة الشركة)
- الرصيد الافتتاحي
- الرصيد الحالي
- تاريخ الافتتاح
- حالة (مفتوحة/مغلقة)

#### حركة الخزينة (CashRegisterTransaction)
- الخزينة
- النوع (Sales, Refunds, Expenses, etc.)
- المبلغ (موجب للدخول، سالب للخروج)
- الوصف
- المرجع (OrderId, ExpenseId, etc.)
- المستخدم
- التاريخ

#### تسوية الخزينة (CashRegisterReconciliation)
- الخزينة
- الرصيد المتوقع
- الرصيد الفعلي
- الفرق
- ملاحظات
- المستخدم
- التاريخ

### قواعد العمل

1. **الشمولية**: الخزينة تشمل كل حركات النقد (ليس فقط المبيعات)
2. **الفصل**: خزينة لكل فرع + خزينة موحدة للشركة
3. **التسوية**: مطابقة دورية (يومية/أسبوعية)
4. **Audit Trail**: تسجيل كل الحركات
5. **Transactions**: كل عملية تؤثر على الخزينة تكون في Transaction

---

## الميزة 7: المصروفات (Expenses)

### نظرة عامة
نظام شامل لإدارة وتتبع مصروفات الشركة والفروع.

### قصص المستخدم

#### 7.1 تسجيل المصروفات
**كـ** Admin/Manager  
**أريد** تسجيل مصروف  
**حتى** أتتبع النفقات

**معايير القبول**:
- فقط Admin و Manager يستطيعون تسجيل المصروفات
- البيانات المطلوبة:
  - الفئة (Category)
  - المبلغ
  - التاريخ
  - الوصف
  - الفرع
  - المورد (اختياري)
  - فاتورة الشراء (اختياري)
  - طريقة الدفع (Cash, Bank, Card, Check)
  - رقم المرجع (للشيكات/التحويلات)
- حفظ كـ Pending في البداية


#### 7.2 فئات المصروفات القابلة للتخصيص
**كـ** Admin  
**أريد** تخصيص فئات المصروفات  
**حتى** تناسب نشاطي

**معايير القبول**:
- فئات افتراضية: Rent, Utilities, Salaries, Supplies, Maintenance, Marketing, Other
- إمكانية إضافة فئات جديدة
- إمكانية تعديل/حذف الفئات
- كل فئة لها: اسم، وصف، لون (للتقارير)
- الفئات على مستوى الشركة (مشتركة بين الفروع)

#### 7.3 الموافقة على المصروفات
**كـ** Admin  
**أريد** الموافقة على المصروفات الكبيرة  
**حتى** أتحكم في النفقات

**معايير القبول**:
- تحديد حد الموافقة (Approval Threshold) في الإعدادات
- المصروفات أقل من الحد: تُعتمد تلقائياً
- المصروفات أكبر من الحد: تحتاج موافقة Admin
- حالات المصروف: Pending, Approved, Paid, Cancelled
- إشعار للـ Admin عند وجود مصروفات تحتاج موافقة
- سجل بكل الموافقات (من وافق، متى)

#### 7.4 المصروفات المتكررة
**كـ** Admin  
**أريد** تسجيل مصروفات متكررة  
**حتى** لا أنسى تسجيلها

**معايير القبول**:
- تحديد: المصروف، التكرار (يومي، أسبوعي، شهري، سنوي)
- تاريخ البدء والانتهاء
- توليد المصروف تلقائياً حسب الجدول
- المصروفات المتكررة تحتاج موافقة أيضاً (حسب المبلغ)
- إمكانية إيقاف/تعديل المصروف المتكرر

#### 7.5 ربط المصروفات
**كـ** مدير  
**أريد** ربط المصروف بالمصدر  
**حتى** أتتبع بدقة

**معايير القبول**:
- ربط المصروف بـ:
  - الفرع (مطلوب)
  - المورد (اختياري)
  - فاتورة الشراء (اختياري)
- عرض كل المصروفات المرتبطة بمورد معين
- عرض كل المصروفات المرتبطة بفاتورة معينة

#### 7.6 تقارير المصروفات الشاملة
**كـ** Admin  
**أريد** تقارير شاملة عن المصروفات  
**حتى** أتحكم في النفقات

**معايير القبول**:

- تقرير المصروفات حسب الفئة
- تقرير المصروفات حسب الفرع
- تقرير المصروفات vs الإيرادات
- تقرير اتجاهات المصروفات (Trends)
- تقرير مقارنة بالميزانية
- تصدير التقارير (PDF/Excel)

#### 7.7 تتبع الميزانية
**كـ** Admin  
**أريد** تحديد ميزانية شهرية  
**حتى** أتحكم في الإنفاق

**معايير القبول**:
- تحديد ميزانية شهرية لكل فئة
- عرض: المصروف الفعلي vs الميزانية
- نسبة الاستهلاك (%)
- تنبيه عند تجاوز 80% من الميزانية
- تنبيه عند تجاوز الميزانية
- تقرير مقارنة الميزانية الفعلية بالمخططة

### البيانات المطلوبة

#### فئة المصروف (ExpenseCategory)
- الاسم
- الوصف
- اللون (للتقارير)
- نشط/غير نشط

#### المصروف (Expense)
- الفئة
- الفرع
- المبلغ
- التاريخ
- الوصف
- المورد (اختياري)
- فاتورة الشراء (اختياري)
- طريقة الدفع
- رقم المرجع
- الحالة (Pending, Approved, Paid, Cancelled)
- متكرر؟
- تكرار (Daily, Weekly, Monthly, Yearly)
- المستخدم الذي سجل
- المستخدم الذي وافق
- تاريخ الموافقة

#### ميزانية المصروفات (ExpenseBudget)
- الفئة
- الفرع (null = كل الفروع)
- الشهر/السنة
- المبلغ المخطط
- المبلغ الفعلي (محسوب)

### قواعد العمل

1. **الصلاحيات**: Admin و Manager فقط يسجلون المصروفات
2. **الموافقة**: حسب حد الموافقة المحدد في الإعدادات
3. **التكرار**: المصروفات المتكررة تُولّد تلقائياً
4. **الربط**: ربط المصروف بالفرع، المورد، الفاتورة
5. **الميزانية**: تتبع شهري مع تنبيهات
6. **Audit Trail**: تسجيل كل العمليات
7. **Transactions**: كل مصروف يؤثر على الخزينة

---

## الميزة 8: لوحة التحكم (Dashboard)

**الحالة**: مؤجل حالياً

سيتم تصميمها لاحقاً بعد إكمال الميزات الأساسية.

---

## الميزة 9: تحسينات الواجهة (UI/UX)

**الحالة**: مؤجل حالياً

سيتم تصميمها لاحقاً بعد إكمال الميزات الأساسية.

---

### المتطلبات العامة

### الأدوار والصلاحيات (مؤكدة)

**الأدوار الحالية** (نستخدمها كما هي):
- Admin
- Cashier

**جدول الصلاحيات**:

| الميزة | Admin | Cashier |
|--------|-------|---------|
| فواتير الشراء - إنشاء | ✅ | ❌ |
| فواتير الشراء - تأكيد | ✅ | ❌ |
| فواتير الشراء - حذف/إلغاء | ✅ | ❌ |
| الورديات - فتح/إغلاق | ✅ | ✅ |
| الورديات - إغلاق بالقوة | ✅ | ❌ |
| الورديات - تسليم | ✅ | ✅ |
| المخزون - نقل بين الفروع | ✅ | ❌ |
| المخزون - تعديل | ✅ | ❌ |
| الخزينة - عرض | ✅ | ❌ |
| الخزينة - تسوية | ✅ | ❌ |
| المصروفات - تسجيل | ✅ | ❌ |
| المصروفات - موافقة | ✅ | ❌ |
| التقارير - عرض | ✅ | ❌ |
| الإعدادات - الشركة | ✅ | ❌ |
| الإعدادات - الفرع | ✅ | ❌ |
| POS - البيع | ✅ | ✅ |

**ملاحظة**: يمكن إضافة دور Manager لاحقاً إذا احتاج العميل

### الإعدادات (Settings Architecture) - مؤكدة

**النموذج**: Hybrid (هجين)

**إعدادات على مستوى الشركة (Company/Tenant) - ثابتة**:


**الأدوار الحالية**:
- Admin
- Cashier

**الأدوار المقترحة**:
- Admin: صلاحيات كاملة
- Manager: إدارة الفرع + تقارير + مصروفات
- Cashier: POS + ورديات فقط

**جدول الصلاحيات المقترح**:

| الميزة | Admin | Manager | Cashier |
|--------|-------|---------|---------|
| فواتير الشراء - إنشاء | ✅ | ✅ | ❌ |
| فواتير الشراء - تأكيد | ✅ | ❌ | ❌ |
| فواتير الشراء - حذف | ✅ | ❌ | ❌ |
| الورديات - فتح/إغلاق | ✅ | ✅ | ✅ |
| الورديات - إغلاق بالقوة | ✅ | ❌ | ❌ |
| المخزون - نقل بين الفروع | ✅ | ❌ | ❌ |
| المخزون - تعديل | ✅ | ✅ | ❌ |
| الخزينة - عرض | ✅ | ✅ (فرعه) | ❌ |
| الخزينة - تسوية | ✅ | ✅ (فرعه) | ❌ |
| المصروفات - تسجيل | ✅ | ✅ | ❌ |
| المصروفات - موافقة | ✅ | ❌ | ❌ |
| التقارير - عرض | ✅ | ✅ (فرعه) | ❌ |
| الإعدادات - الشركة | ✅ | ❌ | ❌ |
| الإعدادات - الفرع | ✅ | ✅ (فرعه) | ❌ |

### الإعدادات (Settings Architecture)

**يحتاج توضيح من المستخدم**:

**إعدادات مقترحة على مستوى الشركة (Company/Tenant)**:
- نسبة الضريبة
- تفعيل/تعطيل الضريبة
- العملة
- المنطقة الزمنية
- السماح بالمخزون السالب
- حد موافقة المصروفات
- شعار الشركة

**إعدادات مقترحة على مستوى الفرع (Branch)**:
- اسم الفرع وعنوانه
- رقم الهاتف
- إعدادات الطابعة
- حد إعادة الطلب للمخزون (لكل منتج)
- أسعار المنتجات (override)

**السؤال المهم**: هل الفروع تستطيع تجاوز إعدادات الشركة؟

**الخيارات**:
1. **ثابتة تماماً**: إعدادات الشركة لا يمكن تجاوزها أبداً
2. **مرنة تماماً**: كل فرع يستطيع تجاوز أي إعداد
3. **هجينة**: بعض الإعدادات ثابتة، بعضها مرن

### Multi-Tenancy

كل الكيانات الجديدة يجب أن تحتوي على:
- `TenantId` (مطلوب)
- `BranchId` (مطلوب، إلا إذا كان على مستوى الشركة)

### Audit Trail

تسجيل كل العمليات في `AuditLog`:
- إنشاء/تعديل/حذف فواتير الشراء
- تأكيد فواتير الشراء
- دفعات فواتير الشراء
- نقل المخزون
- حركات الخزينة
- تسوية الخزينة
- المصروفات والموافقات
- إغلاق الورديات بالقوة

### Financial Integrity

كل العمليات المالية يجب أن تكون في Transaction:
- تأكيد فاتورة شراء (تحديث المخزون)
- نقل المخزون
- حركات الخزينة
- المصروفات

### Type Safety

استخدام Enums لكل الحالات:
- `PurchaseInvoiceStatus`: Draft, Confirmed, Paid, PartiallyPaid, Cancelled, Returned
- `ExpenseStatus`: Pending, Approved, Paid, Cancelled
- `ExpenseRecurrence`: None, Daily, Weekly, Monthly, Yearly
- `CashRegisterTransactionType`: Sales, Refunds, Expenses, BankDeposits, Withdrawals, Transfers, Other
- `PaymentMethod`: Cash, Bank, Card, Check, Fawry

---

## معايير القبول العامة

### الأداء
- تحميل الصفحات < 2 ثانية
- استجابة API < 500ms
- دعم 1000+ منتج بدون تأخير
- دعم 10000+ طلب في التقارير

### الأمان
- مؤجل للنشر المحلي
- سيتم إضافته لاحقاً للنشر السحابي

### الاختبار
- Integration Tests لكل API
- E2E Tests للسيناريوهات الأساسية
- Unit Tests للمنطق المالي

### التوثيق
- توثيق API في `docs/api/API_DOCUMENTATION.md`
- Frontend Types تطابق Backend DTOs 100%
- تعليقات في الكود للمنطق المعقد

---

## الخطوات التالية

1. **الحصول على إجابات للأسئلة المعلقة**
2. **إنشاء ملف التصميم (design.md)**
3. **إنشاء خطة التنفيذ (tasks.md)**
4. **الحصول على موافقة المستخدم**
5. **البدء في التنفيذ**

---

**تاريخ الإنشاء**: 27 يناير 2026  
**آخر تحديث**: 27 يناير 2026  
**الحالة**: في انتظار إجابات المستخدم
