# ملخص المتطلبات - بعد البحث الشامل

## نظرة عامة

تم إجراء بحث شامل عن أفضل الممارسات العالمية لأنظمة POS متعددة الفروع في 2026. هذا الملخص يوضح القرارات النهائية المبنية على البحث.

---

## القرارات الرئيسية ✅

### 1. الأدوار والصلاحيات

**القرار**: Admin + Cashier فقط (كما هو حالياً)

**السبب**:
- النظام موجه لـ SME (Small/Medium Enterprises)
- إضافة Manager يزيد التعقيد بدون فائدة كبيرة
- يمكن إضافة Manager لاحقاً عند الحاجة

**الصلاحيات**:
- **Admin**: كل شيء
- **Cashier**: POS + فتح/إغلاق الوردية فقط

---

### 2. معمارية الإعدادات

**القرار**: Hybrid Model (نموذج هجين)

**المبدأ**: "Centralized Control with Local Flexibility"

**إعدادات ثابتة (Company-Level)**:
1. نسبة الضريبة (14%)
2. تفعيل/تعطيل الضريبة
3. العملة (EGP)
4. المنطقة الزمنية (Africa/Cairo)
5. السماح بالمخزون السالب
6. حد موافقة المصروفات (1000 جنيه)

**إعدادات مرنة (Branch-Level)**:
1. أسعار المنتجات (كل فرع له أسعار مختلفة)
2. إعدادات الطابعة
3. حد إعادة الطلب للمخزون
4. معلومات الفرع (اسم، عنوان، هاتف)
5. ساعات العمل

**المصدر**: SpicePOS, Front Systems, Lightspeed, Rezku

---

### 3. فواتير الشراء والمخزون

**القرار**: لا تعديل/حذف مباشر بعد التأكيد

**القاعدة الذهبية**: "Once confirmed, purchase orders should NOT be directly edited or deleted"

**الحل**:
- **Draft**: تعديل/حذف حر
- **Confirmed**: لا تعديل - يجب الإلغاء أولاً
- **عند الإلغاء**: اسأل المستخدم (modal):
  - "هل تريد تعديل المخزون؟"
  - نعم: إنشاء StockMovement لتعديل المخزون
  - لا: الفاتورة ملغاة بدون تأثير

**الأسباب**:
- Audit Trail: الحفاظ على سجل كامل
- Inventory Integrity: تجنب تضارب المخزون
- Financial Accuracy: دقة الحسابات
- Compliance: متطلبات قانونية

**المصدر**: Microsoft Dynamics, SAP, ERPNext, Odoo, NetSuite

---

### 4. إدارة الورديات

**القرارات**:

#### أ) تسليم الوردية (Handover)
- **الإطار**: 7 دقائق (7-Minute Handover Framework)
- **المعلومات**: الرصيد، عدد الطلبات، مشاكل، ملاحظات
- **المصدر**: Healthcare industry best practices

#### ب) إغلاق بالقوة (Force Close)
- **من**: Admin فقط
- **المتطلبات**: سبب إلزامي + Audit Log + إشعار للكاشير
- **السيناريوهات**:
  1. الكاشير نسي الإغلاق (الأكثر شيوعاً)
  2. الكاشير مريض/غائب
  3. مشكلة تقنية
  4. نزاع (فرق في الرصيد)
  5. طوارئ

#### ج) تنبيه عدم النشاط
- **المدة**: 12 ساعة
- **الخيارات**: إغلاق، استمرار، تسليم
- **إذا استمرار**: تنبيه آخر بعد ساعة

#### د) التعامل مع التعطل
- حفظ حالة الوردية في LocalStorage كل دقيقة
- استعادة تلقائية عند إعادة التشغيل
- عرض تنبيه: "تم استعادة ورديتك"

#### هـ) ورديات متعددة
- يمكن لعدة كاشيرات فتح ورديات في نفس الفرع
- كل وردية مستقلة تماماً

---

### 5. المصروفات (Expenses)

**القرارات**:

#### أ) حد الموافقة (Approval Threshold)
- **الحد الافتراضي**: 1000 جنيه
- **< الحد**: تُعتمد تلقائياً
- **≥ الحد**: تحتاج موافقة Admin
- **قابل للتخصيص** في إعدادات الشركة

**المصدر**: NetSuite, American Express, FastCapital

#### ب) الفئات الافتراضية
1. Rent (إيجار)
2. Utilities (مرافق)
3. Salaries (رواتب)
4. Supplies (مستلزمات)
5. Maintenance (صيانة)
6. Marketing (تسويق)
7. Transportation (مواصلات)
8. Other (أخرى)

#### ج) المصروفات المتكررة
- ضرورية (إيجار، رواتب، فواتير)
- تُولّد تلقائياً حسب الجدول
- تحتاج موافقة أيضاً (حسب المبلغ)

---

### 6. الخزينة (Cash Register)

**القرارات**:

#### أ) التسوية (Reconciliation)
- **التكرار**: يومي
- **الخطوات**:
  1. حساب الرصيد المتوقع (Expected)
  2. عد النقد الفعلي (Actual)
  3. حساب الفرق (Variance)
  4. **تنبيه إذا الفرق > 5%**
  5. تسجيل التسوية

**المصدر**: NetSuite, Emagia, FitSmallBusiness

#### ب) أنواع الحركات
- Sales (من الورديات)
- Refunds (مرتجعات)
- Expenses (مصروفات)
- BankDeposits (إيداع في البنك)
- Withdrawals (سحب)
- Transfers (تحويل بين فروع)
- Other (أخرى)

#### ج) الخزينة vs الوردية
- **الوردية**: خاصة بكاشير واحد، فترة محددة
- **الخزينة**: أعم، تشمل كل حركات النقد في الفرع

---

### 7. المخزون متعدد الفروع

**القرارات**:

#### أ) البنية
- مخزون منفصل لكل فرع
- مخزون مركزي (Central Warehouse)
- نقل بين الفروع (Admin فقط)

#### ب) الأسعار
- سعر افتراضي على مستوى الشركة
- كل فرع يمكنه تجاوز السعر (Branch-Specific Pricing)
- **السبب**: ظروف السوق المحلية تختلف

#### ج) حد إعادة الطلب
- خاص بكل فرع
- يختلف حسب معدل البيع
- تنبيهات تلقائية

**المصدر**: Lightspeed, Dynamics 365, Multi-Store POS Systems

---

## الميزات المؤجلة

### 8. Dashboard (لوحة التحكم)
**الحالة**: مؤجل - سيتم تصميمها بعد إكمال الميزات الأساسية

### 9. UI/UX Improvements
**الحالة**: مؤجل - سيتم تصميمها بعد إكمال الميزات الأساسية

---

## المتطلبات التقنية العامة

### Multi-Tenancy
كل الكيانات الجديدة:
- `TenantId` (مطلوب)
- `BranchId` (مطلوب، إلا إذا كان على مستوى الشركة)

### Audit Trail
تسجيل كل العمليات:
- فواتير الشراء (إنشاء، تأكيد، إلغاء، دفع)
- نقل المخزون
- حركات الخزينة
- المصروفات والموافقات
- إغلاق الورديات بالقوة

### Financial Integrity
كل العمليات المالية في Transaction:
- تأكيد فاتورة شراء
- نقل المخزون
- حركات الخزينة
- المصروفات

### Type Safety
استخدام Enums:
- `PurchaseInvoiceStatus`
- `ExpenseStatus`
- `ExpenseRecurrence`
- `CashRegisterTransactionType`
- `PaymentMethod`

---

## الخطوات التالية

1. ✅ **البحث الشامل** - تم
2. ✅ **تحديد القرارات** - تم
3. ⏳ **إنشاء ملف التصميم** (design.md) - التالي
4. ⏳ **إنشاء خطة التنفيذ** (tasks.md)
5. ⏳ **الحصول على موافقة المستخدم**
6. ⏳ **البدء في التنفيذ**

---

## المراجع

تم البحث في 40+ مقال ودراسة من:
- SpicePOS, Front Systems, Lightspeed, Rezku
- Microsoft Dynamics, SAP, ERPNext, Odoo, NetSuite
- Healthcare Shift Handover Best Practices
- American Express, FastCapital
- Multi-Store POS Systems 2026

---

**تاريخ الإنشاء**: 27 يناير 2026  
**آخر تحديث**: 27 يناير 2026  
**الحالة**: جاهز للتصميم التقني
