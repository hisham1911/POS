# متطلبات الميزة: المصروفات والخزينة

## نظرة عامة

هذه الميزة تضيف إدارة المصروفات اليومية وإدارة الخزينة (Cash Register) لنظام KasserPro.

**الهدف**: تمكين الإدارة من تتبع المصروفات وإدارة حركة النقد في الخزينة بشكل دقيق.

---

## 1. المصروفات (Expenses)

### 1.1 تسجيل المصروفات

**القصة**: كمدير، أريد تسجيل المصروفات اليومية حتى أتمكن من تتبع تكاليف العمل.

**معايير القبول**:
- ✅ يمكن للمدير إنشاء مصروف جديد مع البيانات التالية:
  - التصنيف (مطلوب)
  - المبلغ (مطلوب، > 0)
  - التاريخ (مطلوب)
  - الوصف (مطلوب)
  - المستفيد (اختياري)
  - رقم المرجع (اختياري)
  - ملاحظات (اختياري)
- ✅ المصروف يُنشأ بحالة "Draft" افتراضياً
- ✅ يتم حفظ TenantId و BranchId تلقائياً
- ✅ يتم حفظ معلومات المستخدم الذي أنشأ المصروف

### 1.2 تصنيفات المصروفات

**القصة**: كمدير، أريد تصنيف المصروفات حتى أتمكن من تحليل أنماط الإنفاق.

**معايير القبول**:
- ✅ التصنيفات الافتراضية:
  - المرافق (Utilities): كهرباء، ماء، إنترنت
  - الرواتب (Salaries): رواتب الموظفين
  - الإيجار (Rent): إيجار المحل
  - المستلزمات (Supplies): مستلزمات التشغيل
  - الصيانة (Maintenance): صيانة وإصلاحات
  - أخرى (Other): مصروفات أخرى
- ✅ يمكن للمدير إضافة تصنيفات مخصصة
- ✅ يمكن تفعيل/تعطيل التصنيفات
- ✅ لا يمكن حذف تصنيف مستخدم في مصروفات

### 1.3 الموافقة على المصروفات

**القصة**: كمدير، أريد الموافقة على المصروفات قبل دفعها للتحكم في الإنفاق.

**معايير القبول**:
- ✅ المصروف يمر بالحالات التالية:
  - Draft: مسودة (يمكن التعديل/الحذف)
  - Approved: موافق عليه (لا يمكن التعديل)
  - Paid: مدفوع (لا يمكن التعديل)
  - Rejected: مرفوض (لا يمكن التعديل)
- ✅ فقط المدير يمكنه الموافقة/الرفض
- ✅ عند الموافقة: يتم حفظ معلومات المدير والتاريخ
- ✅ عند الرفض: يجب إدخال سبب الرفض
- ✅ لا يمكن الموافقة على مصروف مدفوع أو مرفوض

### 1.4 دفع المصروفات

**القصة**: كمدير، أريد تسجيل دفع المصروفات وربطها بالخزينة.

**معايير القبول**:
- ✅ يمكن دفع المصروف فقط إذا كان "Approved"
- ✅ طرق الدفع المتاحة:
  - نقدي (Cash): يخصم من الخزينة
  - بطاقة (Card): لا يؤثر على الخزينة
  - تحويل بنكي (BankTransfer): لا يؤثر على الخزينة
- ✅ إذا كان الدفع نقدي:
  - يتم خصم المبلغ من رصيد الخزينة
  - يتم إنشاء CashRegisterTransaction
- ✅ يتم حفظ معلومات الدفع:
  - المبلغ المدفوع
  - تاريخ الدفع
  - طريقة الدفع
  - رقم المرجع (للبطاقة/التحويل)
  - المستخدم الذي دفع
- ✅ بعد الدفع، الحالة تتغير إلى "Paid"

### 1.5 المرفقات

**القصة**: كمدير، أريد إرفاق صور الفواتير/الإيصالات للمصروفات للتوثيق.

**معايير القبول**:
- ✅ يمكن إرفاق ملفات (صور/PDF) للمصروف
- ✅ أنواع الملفات المسموحة: JPG, PNG, PDF
- ✅ الحد الأقصى لحجم الملف: 5 MB
- ✅ يمكن إرفاق عدة ملفات لنفس المصروف
- ✅ يتم حفظ الملفات في مجلد خاص بالـ Tenant
- ✅ يمكن حذف المرفقات (فقط في حالة Draft)

### 1.6 الربط بالوردية

**القصة**: كمدير، أريد ربط المصروفات بالورديات لتتبع أفضل.

**معايير القبول**:
- ✅ يمكن ربط المصروف بوردية (اختياري)
- ✅ إذا تم الربط، يظهر المصروف في تقرير الوردية
- ✅ الكاشير يمكنه تسجيل مصروفات صغيرة خلال ورديته
- ✅ المصروفات المرتبطة بالوردية تظهر في ملخص الوردية

### 1.7 التقارير

**القصة**: كمدير، أريد عرض تقارير المصروفات حسب التصنيف والتاريخ والفرع.

**معايير القبول**:
- ✅ تقرير المصروفات حسب التصنيف:
  - إجمالي المصروفات لكل تصنيف
  - نسبة كل تصنيف من الإجمالي
  - مقارنة بالفترة السابقة
- ✅ تقرير المصروفات حسب التاريخ:
  - يومي، أسبوعي، شهري، سنوي
  - رسم بياني للاتجاهات
- ✅ تقرير المصروفات حسب الفرع (Multi-branch)
- ✅ تصدير التقارير إلى Excel/PDF

---

## 2. الخزينة (Cash Register)

### 2.1 رصيد الخزينة

**القصة**: كمدير، أريد تتبع رصيد الخزينة حتى أعرف النقد المتاح.

**معايير القبول**:
- ✅ كل فرع له خزينة مستقلة
- ✅ الرصيد الحالي = الرصيد الافتتاحي + الإيداعات - السحوبات
- ✅ يتم حساب الرصيد تلقائياً من المعاملات
- ✅ يمكن عرض الرصيد الحالي في أي وقت
- ✅ يمكن عرض تاريخ حركات الخزينة

### 2.2 الرصيد الافتتاحي للوردية

**القصة**: ككاشير، أريد تسجيل الرصيد الافتتاحي عند بدء الوردية.

**معايير القبول**:
- ✅ عند فتح وردية جديدة، يجب تسجيل الرصيد الافتتاحي
- ✅ الرصيد الافتتاحي = رصيد إغلاق الوردية السابقة (افتراضياً)
- ✅ يمكن للكاشير تعديل الرصيد الافتتاحي
- ✅ يتم حفظ الرصيد الافتتاحي في جدول الورديات
- ✅ يتم إنشاء CashRegisterTransaction من نوع "Opening"

### 2.3 الإيداعات والسحوبات

**القصة**: ككاشير، أريد تسجيل الإيداعات والسحوبات من الخزينة.

**معايير القبول**:
- ✅ أنواع المعاملات:
  - Opening: رصيد افتتاحي
  - Deposit: إيداع نقدي
  - Withdrawal: سحب نقدي
  - Sale: بيع (من الطلبات)
  - Expense: مصروف
  - Adjustment: تسوية
  - Transfer: تحويل بين الفروع
- ✅ لكل معاملة:
  - النوع (مطلوب)
  - المبلغ (مطلوب، > 0)
  - التاريخ (مطلوب)
  - السبب/الوصف (مطلوب)
  - المرجع (Order, Expense, etc.)
  - المستخدم
- ✅ الإيداع يزيد الرصيد
- ✅ السحب ينقص الرصيد
- ✅ لا يمكن السحب إذا كان الرصيد غير كافٍ (قابل للتكوين)

### 2.4 التسوية

**القصة**: كمدير، أريد تسوية الخزينة مع العد الفعلي للنقد.

**معايير القبول**:
- ✅ عند إغلاق الوردية، يجب تسوية الخزينة
- ✅ التسوية تتضمن:
  - الرصيد المتوقع (من النظام)
  - الرصيد الفعلي (العد اليدوي)
  - الفرق (Variance)
- ✅ إذا كان هناك فرق:
  - يجب إدخال سبب الفرق
  - يتم إنشاء Adjustment transaction
  - يتم تحديث الرصيد ليطابق الفعلي
- ✅ يتم حفظ معلومات التسوية:
  - المستخدم الذي قام بالتسوية
  - التاريخ والوقت
  - الرصيد المتوقع والفعلي
  - الفرق والسبب
- ✅ لا يمكن إغلاق الوردية بدون تسوية (قابل للتكوين)

### 2.5 الربط بالطلبات

**القصة**: كنظام، أريد تحديث الخزينة تلقائياً عند الدفع النقدي للطلبات.

**معايير القبول**:
- ✅ عند إنشاء طلب بدفع نقدي:
  - يتم زيادة رصيد الخزينة
  - يتم إنشاء CashRegisterTransaction من نوع "Sale"
  - يتم ربط المعاملة بالطلب (OrderId)
- ✅ عند استرجاع طلب نقدي:
  - يتم إنقاص رصيد الخزينة
  - يتم إنشاء CashRegisterTransaction من نوع "Refund"
- ✅ الدفع بالبطاقة/فوري لا يؤثر على الخزينة

### 2.6 الربط بالمصروفات

**القصة**: كنظام، أريد خصم المصروفات النقدية من الخزينة تلقائياً.

**معايير القبول**:
- ✅ عند دفع مصروف نقدي:
  - يتم إنقاص رصيد الخزينة
  - يتم إنشاء CashRegisterTransaction من نوع "Expense"
  - يتم ربط المعاملة بالمصروف (ExpenseId)
- ✅ لا يمكن دفع مصروف نقدي إذا كان الرصيد غير كافٍ

### 2.7 التحويل بين الفروع

**القصة**: كمدير، أريد تحويل نقد من فرع لآخر.

**معايير القبول**:
- ✅ يمكن للمدير تحويل نقد بين الفروع
- ✅ التحويل يتطلب:
  - الفرع المرسل (مطلوب)
  - الفرع المستقبل (مطلوب)
  - المبلغ (مطلوب، > 0)
  - السبب (مطلوب)
  - رقم المرجع (اختياري)
- ✅ يتم إنشاء معاملتين:
  - Withdrawal في الفرع المرسل
  - Deposit في الفرع المستقبل
- ✅ المعاملتان مرتبطتان ببعضهما (TransferReferenceId)
- ✅ لا يمكن التحويل إذا كان رصيد الفرع المرسل غير كافٍ

### 2.8 التقارير

**القصة**: كمدير، أريد عرض تقارير الخزينة والمعاملات.

**معايير القبول**:
- ✅ تقرير حركة الخزينة:
  - كل المعاملات مع التفاصيل
  - الرصيد الجاري بعد كل معاملة
  - تصفية حسب النوع، التاريخ، المستخدم
- ✅ تقرير التسويات:
  - كل التسويات مع الفروقات
  - إجمالي الفروقات (Overages/Shortages)
  - تحليل الأسباب
- ✅ تقرير الخزينة حسب الفرع
- ✅ تصدير التقارير إلى Excel/PDF

---

## 3. التكامل مع الميزات الموجودة

### 3.1 الورديات (Shifts)

**معايير القبول**:
- ✅ عند فتح وردية:
  - يجب تسجيل الرصيد الافتتاحي للخزينة
  - يتم إنشاء Opening transaction
- ✅ خلال الوردية:
  - كل المعاملات النقدية تُسجل في الخزينة
  - يمكن عرض رصيد الخزينة الحالي
- ✅ عند إغلاق وردية:
  - يجب تسوية الخزينة
  - يتم حفظ الرصيد الختامي
  - يتم حساب إجمالي المصروفات في الوردية

### 3.2 الطلبات (Orders)

**معايير القبول**:
- ✅ الدفع النقدي يزيد رصيد الخزينة تلقائياً
- ✅ الاسترجاع النقدي ينقص رصيد الخزينة تلقائياً
- ✅ يتم ربط المعاملة بالطلب

### 3.3 فواتير الشراء (Purchase Invoices)

**معايير القبول**:
- ✅ دفع فاتورة شراء نقدياً ينقص رصيد الخزينة
- ✅ يتم إنشاء CashRegisterTransaction من نوع "SupplierPayment"
- ✅ يتم ربط المعاملة بالفاتورة

---

## 4. الصلاحيات

### 4.1 المدير (Admin)

**يمكنه**:
- ✅ كل عمليات المصروفات (إنشاء، موافقة، دفع، حذف)
- ✅ إدارة تصنيفات المصروفات
- ✅ كل عمليات الخزينة
- ✅ التسوية
- ✅ التحويل بين الفروع
- ✅ عرض كل التقارير

### 4.2 الكاشير (Cashier)

**يمكنه**:
- ✅ تسجيل مصروفات صغيرة (حد أقصى قابل للتكوين)
- ✅ تسجيل الرصيد الافتتاحي للوردية
- ✅ عرض رصيد الخزينة الحالي
- ✅ تسوية الخزينة عند إغلاق الوردية
- ✅ عرض معاملات الخزينة لورديته فقط

**لا يمكنه**:
- ❌ الموافقة على المصروفات
- ❌ حذف معاملات الخزينة
- ❌ التحويل بين الفروع
- ❌ عرض تقارير الفروع الأخرى

---

## 5. قواعد العمل

### 5.1 المصروفات

1. **حالات المصروف**:
   - Draft → Approved ✅
   - Draft → Rejected ✅
   - Approved → Paid ✅
   - لا يمكن التعديل بعد الموافقة ❌
   - لا يمكن الحذف بعد الموافقة ❌

2. **الدفع**:
   - يمكن الدفع فقط للمصروفات الموافق عليها
   - الدفع النقدي يتطلب رصيد كافٍ في الخزينة
   - بعد الدفع، لا يمكن التعديل أو الحذف

3. **المرفقات**:
   - يمكن الإرفاق فقط في حالة Draft
   - الحد الأقصى: 5 ملفات، 5 MB لكل ملف
   - الأنواع المسموحة: JPG, PNG, PDF

### 5.2 الخزينة

1. **الرصيد**:
   - لا يمكن أن يكون سالباً (قابل للتكوين)
   - يتم حسابه تلقائياً من المعاملات
   - التسوية تحدث الرصيد ليطابق الفعلي

2. **المعاملات**:
   - كل معاملة يجب أن يكون لها سبب/وصف
   - لا يمكن حذف المعاملات (Audit Trail)
   - يمكن فقط إنشاء Adjustment للتصحيح

3. **التسوية**:
   - مطلوبة عند إغلاق الوردية
   - الفرق يجب أن يكون له سبب
   - يتم إنشاء Adjustment تلقائياً

4. **التحويل**:
   - يتطلب رصيد كافٍ في الفرع المرسل
   - يتم إنشاء معاملتين مرتبطتين
   - لا يمكن إلغاء التحويل (يجب إنشاء تحويل عكسي)

---

## 6. المتطلبات غير الوظيفية

### 6.1 الأداء

- ✅ عرض قائمة المصروفات: < 500ms
- ✅ حساب رصيد الخزينة: < 200ms
- ✅ إنشاء معاملة: < 300ms
- ✅ التقارير: < 2s

### 6.2 الأمان

- ✅ Multi-tenancy: عزل كامل بين الـ Tenants
- ✅ Authorization: التحقق من الصلاحيات في كل API
- ✅ Audit Trail: تسجيل كل العمليات
- ✅ Validation: التحقق من البيانات في Backend و Frontend

### 6.3 قابلية التوسع

- ✅ دعم عدد غير محدود من التصنيفات
- ✅ دعم عدد غير محدود من المعاملات
- ✅ دعم Multi-branch
- ✅ دعم Multi-currency (مستقبلاً)

### 6.4 سهولة الاستخدام

- ✅ واجهة بسيطة وسهلة
- ✅ رسائل خطأ واضحة بالعربية
- ✅ تأكيد قبل العمليات الحساسة
- ✅ تلميحات ومساعدة

---

## 7. معايير النجاح

الميزة تعتبر ناجحة عندما:

1. ✅ يمكن للمدير تسجيل وإدارة المصروفات بكل أنواعها
2. ✅ يمكن للكاشير تسجيل مصروفات صغيرة خلال الوردية
3. ✅ رصيد الخزينة دقيق ويعكس كل المعاملات
4. ✅ التسوية تعمل بشكل صحيح وتكتشف الفروقات
5. ✅ كل المعاملات النقدية (طلبات، مصروفات، فواتير) تؤثر على الخزينة
6. ✅ التقارير توفر رؤية واضحة للمصروفات وحركة النقد
7. ✅ النظام يمنع العمليات غير الصحيحة (رصيد سالب، دفع بدون موافقة، إلخ)
8. ✅ Audit Trail كامل لكل العمليات
9. ✅ كل الـ Tests تعمل بنجاح
10. ✅ الأداء ضمن المعايير المحددة

---

**تاريخ الإنشاء**: 29 يناير 2026  
**الحالة**: ✅ جاهز للتصميم
